---
title: "ENTSAPP Reference manual"
author: "Josep Pueyo-Ros"
format: html
toc: true
execute: 
  echo: false
  message: false
  warning: false
editor_options: 
  chunk_output_type: console
embed-resources: true
---

```{r setup}
#| include: false

library(tidyverse)
library(httr2)
library(jsonlite)
library(gt)

url_api <- "https://snappapi-v2.icradev.cat/"
```


::: {.callout-note}

This document is work in progress. Content will evolve as the tool evolves.

:::

# Knowledge base

## Technologies

[@tbl-techs] shows all available technologies and [@tbl-vars-description] all the information included in the table. Technologies were collected using expert-based knowledge as explained [here](https://iwaponline.com/bgs/article/5/2/235/99349/Development-of-a-decision-support-system-to-select?searchresult=1) and [here](https://zenodo.org/records/10688075). 

The available technologies can be consulted in the tool or can be downloaded as [csv](http://snappapi-v2.icradev.cat/technologies.csv) or [json](https://snappapi-v2.icradev.cat/technologies/technologies).

```{r list_tech}
#| label: tbl-techs
#| tbl-cap: Technologies included in Nat4Wat

read_csv(here::here("public/technologies.csv")) |> 
  select(Technology = name, Type = type, Function = module) |> 
  arrange(desc(Function), Type, Technology) |> 
  mutate(Function = if_else(Function == "treatment", "Water treatment", "Stormwater management")) |> 
  gt() |> 
  opt_interactive(
    use_filters = TRUE,
    use_page_size_select = TRUE
  )

```

```{r vars_description}
#| label: tbl-vars-description
#| tbl-cap: Information provided by experts for each technology

readxl::read_excel("C:/Users/jpueyo/ICRA/MULTISOURCE - WP4/knowledge base/data/delphi/first_round.xlsx",
                   sheet = "Descriptions") |> 
  filter(!is.na(Description)) |> 
  filter(Variable != "confidence_level") |> 
  add_row(
    tribble(
      ~ Variable, ~ Description, ~ `Values or units`,
      "infiltration", "Does the techology allow infiltration into the ground?", "yes-no",
      "storage_capacity", "The granulometry of the retention layer (phi)", "m3/m3",
      "hc", "Hydraulic conductivity of the retention layer", "mm/s",
      "cost", "Construction costs", "€/m2"
    )
  ) |> 
  mutate(`Values or units` = str_replace_all(`Values or units`, "2", "<sup>2</sup>")) |> 
  mutate(`Values or units` = str_replace_all(`Values or units`, "3", "<sup>3</sup>")) |> 
  mutate(`Values or units` = if_else(Variable == "type", 
                                     "BS: Bioretention systems<br>
                                     CW: Constructed wetlands<br>
                                     DB: Detention basins<br>
                                     FS: Filter strips<br>
                                     GR: Green roofs<br>
                                     GW: Green walls<br>
                                     HA: Hydroponics and Aquaponics<br>
                                     I-SRS: In-stream restoration systems<br>
                                     MS: Multi-stage systems,<br>
                                     NW: Natural wetlands<br>
                                     PL: Ponds and lagoons<br>
                                     PO: Ponds<br>
                                     PP: Pervious pavemen<br>
                                     SIS: Soil infiltration systems<br>
                                     SW: Swales<br>
                                     TR: Trees<br>
                                     WS: Willow systems",
                                     `Values or units`)) |> 
  gt() |> 
  fmt_markdown(columns = c(`Values or units`)) |>
  opt_interactive(
        use_search = TRUE,
    use_page_size_select = TRUE
  )

```

::: {.callout-note}
## Aknowledgement

The illustrations of the technologies showed in Nat4Wat were made by Lide Jaurrieta.

:::


## Scientific case-studies

Scientific case studies are the result of several systematic scientific reviews, as explained [here](https://iwaponline.com/bgs/article/5/2/235/99349/Development-of-a-decision-support-system-to-select?searchresult=1) and [here](https://zenodo.org/records/10688075). User can upload new scientific case studies that are published after a peer-review process. The case studies, especially for water treatment, are used by machine learning models to estimate the surface based on inflow and concentration in the inlet and outlet.

## Commercial case-studies

Commerical case studies are provided by companies with expertise in building the technologies avaiable in the tool. To upload a commercial case, a company needs to register as a company and upload the required information. The commercial cases are published after a peer-review process.

## Water inputs and transformations

### Water types

The water types is the primary selector of technologies. In the knowledge base, each technology is assigned to one or several types of water. In treatment scenarios, if any more data is provided, the BOD concentration and the inflow as estimated from the type of water according to the values in @tbl-water-types.

```{r water_types}
#| label: tbl-water-types
#| tbl-cap: Water types accepted as input

resp <- request(paste0(url_api, "utils/water-types")) |> 
  req_perform() |> 
  resp_body_json()

water_types <- tibble(
  module = map_chr(resp, \(x) x$module),
  name = map_chr(resp, \(x) x$name),
  pe = map_dbl(resp, \(x) x$pe),
  litresPerson = map_int(resp, \(x) pluck(x, "litresPerson", .default = NA))
) |> 
  mutate(bod = pe * 60, .after = pe)

water_types |> 
  mutate(module = case_match(
    module,
    "swm" ~ "Storm water management scenario",
    "treatment" ~ "Water treatment scenario"
  )) |> 
  gt(
      rowname_col = "name",
      groupname_col = "module"
     ) |> 
  fmt_number(
    columns = pe,
    decimals = 2
    ) |> 
  fmt_number(
    columns = bod,
    decimals = 0
  ) |> 
  sub_missing(missing_text = "") |> 
  cols_label(pe ~ "people equivalent",
             bod ~ "gr BOD/day",
             litresPerson ~ "litres/person/day")

```

### Conversions

As mentioned above, in treatment scenarios, when input data is not provided, the required data to estimate the surface is estimated as follows. To estimate the surface, user must provide, at least, the people served by the technology or the inflow.

If people served is provided, daily inflow is estimated as $people · litresPerson$.

# Selection of technologies

The selection of technologies is based on the information provided by experts ([@tbl-techs] and [@tbl-vars-description]). The inputs from the user are matched with the information of each technology and technologies not fulfilling one of the conditions are rejected.

- If "Any wastewater" is selected, technologies for stormwater management are rejected, but all technologies for water treatment are selected, regardless of the type of wastewater they can handle.

- If "Vertical" is selected, vertical technologies such as green walls are selected. This option does not reject horizontal technologies.

- If "household building solutions" is selected, all technologies designed for larger scales are rejected. However, if this is not selected, no technology is rejected.

- When some input values for an ecosystem service are provided, all technologies with a smaller score in that ecosystem service are rejected, but not the ones with larger scores. For instance, if a user selects level 2 in temperature regulation, only technologies with scores 2 or 3 in temperature regulation are selected.

- On the other hand, when an input value is provided for an operational constraint (required manpower, required skills or biohazard risks), technologies with larger scores are rejected. For instance, if a user selects level 2 in required skills, only technologies with scores 0, 1 or 2 in required skills are selected.

- If energy requirements are selected as yes, all technologies that need electrical energy to work are selected. On the other hand, if energy requirements are selected as no, all technologies that need electrical energy to work are rejected.


# Surface estimation {#sec-surface-estimation}

## Treatment surface

The method to estimate the surface of a technology for water treatment depends on two factors ([@fig-cascade_model]):

- The information provided by the user about the water requirements.
- The information available in the tool regarding the technology.

![Cascade model diagram](assets/cascadE_model.png){#fig-cascade_model}

If input and output concentrations are provided for more than one pollutant, the surface returned is the minimal surface to fulfil all removal requirements (i.e. the maximum surface among pollutants used in the estimation).

### Target concentrations in the receiving environment

In case that the user provides target concentrations in the receiving environment (instead of outlet concentrations), a mass balance is used to calculate the required concentrations in the outlet tio fulfil the condition. For that, the user must provide river inflow and river's upstream concentrations for each pollutant of interest. The required oulet concentration is calculated as follows:

$$
C_o = \frac{Q_r~(C_u - C_t)}{Q_i}
$$

where:

- C~o~: Required concentration in the outlet
- C~u~: Upstream river concentration
- C~t~: Target concentration required in the downstream river
- Q~r~: River flow
- Q~i~: Technology inflow

## Retention - infiltration surface

The volume that the technology can manage can be calculated with the following equation:

:::: {.columns}

::: {.column width="50%"}

$$
Q = A · (\phi K_tt'_0 + K_st'_1) + Q_dt'_1
$$
:::

::: {.column width="50%"}

$$
if ~ K_tt <= H, ~ then ~ t'_0 = t ~ and ~ t'_1 = 0 
$$

$$
otherwise, ~ t'_0 = \frac{H}{K_t} ~ and ~ t'_1 = t - t'_0
$$

:::

::::

where:

- _Q_: Volume at the time _t_ that the technology can retain or infiltrate (m^3^).
- _A_: surface of the technology (m^2^)
- _K~t~_: Hydraulic conductivity of the technology's layers (m/s). When the technology stores water in a superficial layer, this is assumed as 10 m/s.
- _K~s~_: Hydraulic conductivity of the receiving soil (m/s).
- _t_: duration of the rain event (s)
- $\phi$: storage capacity of the technology (m^3^/m^3^)
- _H_: height of the technology (m).
- _Q~d~_: The flow of the drainage pipe (m^3^/s).

![Schema for an infiltration trench](assets/schema_swm.png){#fig-schema_swm}

The method assumes that the critical time of the event (when the maximum retention volume is needed) is at the end of the event.

From the previous equation, the surface can be estimated as follows:

:::: {.columns}

::: {.column width="50%"}

$$
A = \frac{Q - Q_dt'_1}{\phi K_tt'_0 + K_st'_1}
$$

:::

::: {.column width="50%"}

$$
if ~ K_tt <= H, ~ then ~ t'_0 = t ~ and ~ t'_1 = 0
$$

$$
otherwise, ~ t'_0 = \frac{H}{K_t} ~ and ~ t'_1 = t - t'_0
$$

:::

::::

_Q_ can be approximated as follows:

$$
Q = \frac{r_{cum(t)}A_c}{1000}
$$

where: 

- _r~cum(t)~_: Cummulated rain at time _t_ (mm).
- _A~c~_: Area of the catchment area of the technology (in m^2^).

*Q~d~* can be calculated as *Q~d~ = AV*, where _V_ can be replaced by the Manning equation as follows:

$$
Q_d = A\frac{1}{n}(\frac{A}{P})^{\frac{2}{3}}S^{\frac{1}{2}}
$$

where:

- *A*: Section of the pipe (m^2^)
- *n*: Roughness coefficient for the pipe's material(default: 0.0011)
- *P*: Perimeter of the pipe (m).
- *S*: slope of the pipe (default: 3%).

The user can provide the diameter of the pipe. If not provided, it is assumed that there is not drainage pipe.

The output of the method contains the surface needed to retain or infiltrate the volume reported and the daily volume that can be retained or infiltrated by the technology with the high interval of the surface.

When the user also provides the available area, the surface estimated is to manage all the volume reported, regardless of the available area. However, the `max_volume` reports the maximum volume that can be retained or infiltrated by the technology using the available area. If the surface needed is lower than the available area, the `max_volume` always equal to the volume reported by the user (= `cumRain` x `catchmentArea` x 0.001). A flag named `enough_area` indicates when the available area is larger than the surface needed to manage the reported flow.

# Multicriteria decision analysis

Multicriteria decision analysis (MCDA) is a method to weight different criteria to get a final score for each technology. Each criteria is weighted between 0 and 5 regarding the importance that the criteria has in the use case.

## Criteria

### Environmental impact

It is calculated as a combination of energy use, eutrophication risks and biohazard risks, at this moment it is not calculated from rain and runoff technologies because all variables used have the same value and, therefore, the environmental impact is the same for all technologies:

$$
EI = \frac{(1 - e) + r_{NH_4} + r_{NO_2} + (1 - \frac{br}{3})}{4}
$$

Where $EI$ is environmental impact ($\in[0,1]$) being 1 the lowest impact; $e$ is energy use ($\in{0,1}$); $r_{NH_4}$ is the capacity of the technology to remove ammonia ($\in\{0,1\}$); $r_{NO_2}$ is the capacity of the technology to remove nitrates ($\in\{0,1\}$); and $br$ is the biohazard risk of the technology ($\in[0,3]$).

### Multifunctionality

Multifunctionality considers the capacity of the tehcnology to provide cobenefits and ecosystem services. It is calculated as an average of all cobenefits:

$$
M = \frac{1}{N}\sum_{i = 1}^N{\frac{cb_i}{3}}
$$

Where $M$ stands for multifunctionality ($\in[0,1]$) being 1 the highest multifunctionality; $N$ is the number of considered cobenefits; and $cb_i$ is the score for the cobenefit $i$ ($\in[0,3]$). 

### Space requirements

Space requirements is the surface needed for the technology. In case, the scenario has enough information to estimate the surface, the estimated mean surface is used. Otherwise, the ratio $m2/pe$ for each technology is used instead. The surfaces of compared technologies are normalized as follows:

$$
SR_i = \frac{s_{min}}{s_i}
$$
where $SR_i$ is the space requirements ($\in(0,1]$) for technology $i$; $s_{min}$ is the minimum surface among all compared technologies and $s_i$ is the surface of technology $i$. when the data to estimate the surface is not provided, the ratio of $m^2/pe$ is used for treatment technologies (larger ratio equals to smaller score) and $sc * d$ is used for stormwater management technologies. See @sec-surface-estimation for more details about surface estimation.

### Operation and manteinance

Operation and manteinance is the level of difficulty in keep the technology properly working. It is estimated as a combination of required manpower and required skills:

$$
OM = 1 - \frac{m + s}{6}
$$
Where $OM$ is the operation and manteinance score ($\in[0,1]$) being 1 the lowest operation and manteinance requirements; $m$ is the level of required manpower ($\in[0,3]$); and $s$ is the level of required skills ($\in[0,3]$).

### Cost

The cost is calculated as the total construction cost using the estimated surface. The costs for all technologies are normalized regarding the technology with the minimal cost.

$$
\hat{c}_i = \frac{c_{min}}{c_i}
$$
where $\hat{c}_i$ is the normalized construction cost ($\in(0,1]$) for technology $i$; $c_{min}$ is the minimum cost among all compared technologies and $c_i$ is the cost of technology $i$.

## Weights

Each criteria is weighted by the user according to the priorities of the specific case. Each criteria can be weighted using a 5-point Likert scale from "Not important at all" to "Very important". Then this information is used to weight the score of each criteria.

Then this weights are converted to proportions ($\Sigma{w} = 1$). Therefore, weighted all criteria as very important get the same results that weighted all of them as not important:

$$
p_{wc} = \frac{w_c}{\Sigma{w}}
$$
where $p_{wc}$ is the proportion ($\in[0,1]$) of the weight for criteria $c$; $w_c$ is the weight ($\in[0,5]$) for criteria $c$ and $\Sigma{w}$ is the sum of the weights of all criteria.
