---
title: "ENTSAPP Reference manual"
author: "Josep Pueyo-Ros"
format: html
toc: true
execute: 
  echo: false
editor_options: 
  chunk_output_type: console
embed-resources: true
---

```{r setup}
#| include: false

library(tidyverse)
library(httr2)
library(jsonlite)
library(gt)

url_api <- "https://snappapi-v2.icradev.cat/"
```


::: {.callout-note}

This document is work in progress. Content will evolve as the tool evolves.

:::

# Knowledge base

## Technologies

## Scientific case-studies

## Commercial case-studies

## Water inputs and transformations

### Water types

The water types is the primary selector of technologies. In the knowledge base, each technology is assigned to one or several types of water. In treatment scenarios, if any more data is provided, the BOD concentration and the inflow as estimated from the type of water according to the values in @tbl-water-types.

```{r water_types}
#| label: tbl-water-types
#| tbl-cap: Water types accepted as input

resp <- request(paste0(url_api, "utils/water-types")) |> 
  req_perform() |> 
  resp_body_json()

water_types <- tibble(
  module = map_chr(resp, \(x) x$module),
  name = map_chr(resp, \(x) x$name),
  pe = map_dbl(resp, \(x) x$pe),
  litresPerson = map_int(resp, \(x) pluck(x, "litresPerson", .default = NA))
) |> 
  mutate(bod = pe * 60, .after = pe)

water_types |> 
  mutate(module = case_match(
    module,
    "swm" ~ "Storm water management scenario",
    "treatment" ~ "Water treatment scenario"
  )) |> 
  gt(
      rowname_col = "name",
      groupname_col = "module"
     ) |> 
  fmt_number(
    columns = pe,
    decimals = 2
    ) |> 
  fmt_number(
    columns = bod,
    decimals = 0
  ) |> 
  sub_missing(missing_text = "") |> 
  cols_label(pe ~ "people equivalent",
             bod ~ "gr BOD/day",
             litresPerson ~ "litres/person/day")

```

### Conversions

As mentioned above, in treatment scenarios, when input data is not provided, the required data to estimate the surface is estimated as follows. To estimate the surface, user must provide, at least, the people served by the technology or the inflow.

If people served is provided, daily inflow is estimated as $people · litresPerson$.

If BOD concentration is not provided, it is estimated as $\frac{L_{BOD}}{Q}$

# Selection of technologies


# Surface estimation {#sec-surface-estimation}

## Treatment surface

## Retention - infiltration surface

**TODO: Add a scheme of a technology (Lide)**

The volume that the technology can manage can be calculated with the following equation:

:::: {.columns}

::: {.column width="50%"}

$$
Q = A · (\phi K_tt'_0 + K_st'_1) + Q_dt'_1
$$
:::

::: {.column width="50%"}

$$
if ~ K_tt <= H, ~ then ~ t'_0 = t ~ and ~ t'_1 = 0 
$$

$$
otherwise, ~ t'_0 = \frac{H}{K_t} ~ and ~ t'_1 = t - t'_0
$$

:::

::::

where:

- _Q_: Volume at the time _t_ that the technology can retain or infiltrate (m^3^).
- _A_: surface of the technology (m^2^)
- _K~t~_: Hydraulic conductivity of the technology's layers (m/s). When the technology stores water in a superficial layer, this is assumed as 10 m/s.
- _K~s~_: Hydraulic conductivity of the receiving soil (m/s).
- _t_: duration of the rain event (s)
- $\phi$: storage capacity of the technology (m^3^/m^3^)
- _H_: height of the technology (m).
- _Q~d~_: The flow of the drainage pipe (m^3^/s).

The method assumes that the critical time of the event (when the maximum retention volume is needed) is at the end of the event.

From the previous equation, the surface can be estimated as follows:

:::: {.columns}

::: {.column width="50%"}

$$
A = \frac{Q - Q_dt'_1}{\phi K_tt'_0 + K_st'_1}
$$

:::

::: {.column width="50%"}

$$
if ~ K_tt <= H, ~ then ~ t'_0 = t ~ and ~ t'_1 = 0
$$

$$
otherwise, ~ t'_0 = \frac{H}{K_t} ~ and ~ t'_1 = t - t'_0
$$

:::

::::

_Q_ can be approximated as follows:

$$
Q = \frac{r_{cum(t)}A_c}{1000}
$$

where: 

- _r~cum(t)~_: Cummulated rain at time _t_ (mm).
- _A~c~_: Area of the catchment area of the technology (in m^2^).

*Q~d~* can be calculated as *Q~d~ = AV*, where _V_ can be replaced by the Manning equation as follows:

$$
Q_d = A\frac{1}{n}(\frac{A}{P})^{\frac{2}{3}}S^{\frac{1}{2}}
$$

where:

- *A*: Section of the pipe (m^2^)
- *n*: Roughness coefficient for the pipe's material(default: 0.0011)
- *P*: Perimeter of the pipe (m).
- *S*: slope of the pipe (default: 3%).

The user can provide the diameter of the pipe. If not provided, it is assumed that there is not drainage pipe.

The output of the method contains the surface needed to retain or infiltrate the volume reported and the daily volume that can be retained or infiltrated by the technology with the high interval of the surface.

When the user also provides the available area, the surface estimated is to manage all the volume reported, regardless of the available area. However, the `max_volume` reports the maximum volume that can be retained or infiltrated by the technology using the available area. If the surface needed is lower than the available area, the daily flow always equal to the volume reported by the user. A flag named `enough_area` indicates when the available area is larger than the surface needed to manage the reported flow.

# Multicriteria decision analysis

Multicriteria decision analysis (MCDA) is a method to weight different criteria to get a final score for each technology. Each criteria is weighted between 0 and 5 regarding the importance that the criteria has in the use case.

## Criteria

### Environmental impact

It is calculated as a combination of energy use, eutrophication risks and biohazard risks, at this moment it is not calculated from rain and runoff technologies because all variables used have the same value and, therefore, the environmental impact is the same for all technologies:

$$
EI = \frac{(1 - e) + r_{NH_4} + r_{NO_2} + (1 - \frac{br}{3})}{4}
$$

Where $EI$ is environmental impact ($\in[0,1]$) being 1 the lowest impact; $e$ is energy use ($\in{0,1}$); $r_{NH_4}$ is the capacity of the technology to remove ammonia ($\in\{0,1\}$); $r_{NO_2}$ is the capacity of the technology to remove nitrates ($\in\{0,1\}$); and $br$ is the biohazard risk of the technology ($\in[0,3]$).

### Multifunctionality

Multifunctionality considers the capacity of the tehcnology to provide cobenefits and ecosystem services. It is calculated as an average of all cobenefits:

$$
M = \frac{1}{N}\sum_{i = 1}^N{\frac{cb_i}{3}}
$$

Where $M$ stands for multifunctionality ($\in[0,1]$) being 1 the highest multifunctionality; $N$ is the number of considered cobenefits; and $cb_i$ is the score for the cobenefit $i$ ($\in[0,3]$). 

### Space requirements

Space requirements is the surface needed for the technology. In case, the scenario has enough information to estimate the surface, the estimated mean surface is used. Otherwise, the ratio $m2/pe$ for each technology is used instead. The surfaces of compared technologies are normalized as follows:

$$
SR_i = \frac{s_{min}}{s_i}
$$
where $SR_i$ is the space requirements ($\in(0,1]$) for technology $i$; $s_{min}$ is the minimum surface among all compared technologies and $s_i$ is the surface of technology $i$. when the data to estimate the surface is not provided, the ratio of $m^2/pe$ is used for treatment technologies (larger ratio equals to smaller score) and $sc * d$ is used for stormwater management technologies. See @sec-surface-estimation for more details about surface estimation.

### Operation and manteinance

Operation and manteinance is the level of difficulty in keep the technology properly working. It is estimated as a combination of required manpower and required skills:

$$
OM = 1 - \frac{m + s}{6}
$$
Where $OM$ is the operation and manteinance score ($\in[0,1]$) being 1 the lowest operation and manteinance requirements; $m$ is the level of required manpower ($\in[0,3]$); and $s$ is the level of required skills ($\in[0,3]$).

### Cost

The cost is calculated as the total construction cost using the estimated surface. The costs for all technologies are normalized regarding the technology with the minimal cost.

$$
\hat{c}_i = \frac{c_{min}}{c_i}
$$
where $\hat{c}_i$ is the normalized construction cost ($\in(0,1]$) for technology $i$; $c_{min}$ is the minimum cost among all compared technologies and $c_i$ is the cost of technology $i$.

## Weights

Each criteria is weighted by the user according to the priorities of the specific case. Each criteria can be weighted using a 5-point Likert scale from "Not important at all" to "Very important". Then this information is used to weight the score of each criteria.

Then this weights are converted to proportions ($\Sigma{w} = 1$). Therefore, weighted all criteria as very important get the same results that weighted all of them as not important:

$$
p_{wc} = \frac{w_c}{\Sigma{w}}
$$
where $p_{wc}$ is the proportion ($\in[0,1]$) of the weight for criteria $c$; $w_c$ is the weight ($\in[0,5]$) for criteria $c$ and $\Sigma{w}$ is the sum of the weights of all criteria.
